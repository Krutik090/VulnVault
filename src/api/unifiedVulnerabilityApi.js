// =======================================================================
// FILE: src/api/unifiedVulnerabilityApi.js
// PURPOSE: API calls for the new Unified Vulnerability Model (Nessus/Web/Mobile)
// =======================================================================

const API_URL = import.meta.env.VITE_API_BASE_URL;

/**
 * Helper to handle fetch responses consistently
 */
const handleResponse = async (response) => {
    // Check if response has content
    const contentType = response.headers.get("content-type");

    let data = {};
    if (contentType && contentType.includes("application/json")) {
        data = await response.json();
    } else {
        // If backend sent a 500 without JSON
        if (!response.ok) throw new Error(`Server Error: ${response.status}`);
    }

    if (!response.ok) {
        throw new Error(data.message || `Request failed with status ${response.status}`);
    }

    return data;
};

/**
 * Get all unified vulnerabilities for a specific project
 * @param {string} projectId 
 */
export const getProjectUnifiedVulnerabilities = async (projectId) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/project/${projectId}`, {
        method: 'GET',
        credentials: 'include' // Sends httpOnly cookies (JWT)
    });

    return handleResponse(response);
};

/**
 * Get a single unified vulnerability by ID
 * @param {string} id 
 */
export const getUnifiedVulnerabilityById = async (id) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/${id}`, {
        method: 'GET',
        credentials: 'include'
    });

    return handleResponse(response);
};

/**
 * Create a new unified vulnerability (Manual Entry)
 * @param {object} vulnData 
 */
export const createUnifiedVulnerability = async (vulnData) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(vulnData),
        credentials: 'include'
    });

    return handleResponse(response);
};

/**
 * Update a unified vulnerability
 * @param {string} id 
 * @param {object} updateData 
 */
export const updateUnifiedVulnerability = async (id, updateData) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateData),
        credentials: 'include'
    });

    return handleResponse(response);
};

/**
 * Delete a unified vulnerability
 * @param {string} id 
 */
export const deleteUnifiedVulnerability = async (id) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/${id}`, {
        method: 'DELETE',
        credentials: 'include'
    });

    return handleResponse(response);
};

/**
 * Get statistics for a project (Severity Counts)
 * @param {string} projectId 
 */
export const getUnifiedVulnerabilityStats = async (projectId) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/project/${projectId}/stats`, {
        method: 'GET',
        credentials: 'include'
    });

    return handleResponse(response);
};

/**
 * Fetches the full details of a single unified vulnerability instance.
 */
export const getUnifiedVulnerabilityInstance = async (vulnId) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/${vulnId}`, {
        credentials: 'include',
    });
    if (!response.ok) throw new Error('Failed to fetch vulnerability details.');
    return response.json();
};

/**
 * Updates a specific unified vulnerability instance.
 */
export const updateUnifiedVulnerabilityInstance = async (vulnId, data) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/${vulnId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'include',
    });
    return handleResponse(response);
};

/**
 * Unified Uploads: Adds images to an existing unified vulnerability.
 */
export const addUnifiedUploads = async (vulnerabilityId, files, captions) => {
    const formData = new FormData();
    files.forEach((file) => formData.append('images', file));
    formData.append('captions', JSON.stringify(captions.map((c) => c || '')));

    const response = await fetch(`${API_URL}/unified-vulnerabilities/${vulnerabilityId}/uploads`, {
        method: 'POST',
        body: formData,
        credentials: 'include',
    });
    return handleResponse(response);
};

/**
 * Unified Deletions: Deletes a specific image from a unified vulnerability.
 */
export const deleteUnifiedUpload = async (vulnId, uploadId) => {
    const response = await fetch(`${API_URL}/unified-vulnerabilities/${vulnId}/uploads/${uploadId}`, {
        method: 'DELETE',
        credentials: 'include',
    });
    return handleResponse(response);
};